#!/bin/bash

# –ü–æ—Ä—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞
PORT=5175

echo "üßπ –û—á–∏—Å—Ç–∫–∞ –ø–æ—Ä—Ç–∞ $PORT..."
# –ù–∞—Ö–æ–¥–∏–º –∏ —É–±–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–º –ø–æ—Ä—Ç—É
lsof -ti:$PORT | xargs kill -9 2>/dev/null

# –£–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã vite –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞
pkill -f "manuscript-editor/node_modules/.bin/vite" 2>/dev/null

echo "‚úÖ –ü–æ—Ä—Ç –æ—á–∏—â–µ–Ω"

# –ù–µ–±–æ–ª—å—à–∞—è –ø–∞—É–∑–∞ –¥–ª—è –æ—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏—è –ø–æ—Ä—Ç–∞
sleep 1

echo "üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É $PORT..."
# –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –≤ —Ñ–æ–Ω–µ
npx vite --port $PORT &

# –ñ–¥–µ–º –ø–æ–∫–∞ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if lsof -i:$PORT >/dev/null 2>&1; then
    echo "‚úÖ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
    
    # –û—Ç–∫—Ä—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä
    echo "üåê –û—Ç–∫—Ä—ã—Ç–∏–µ –±—Ä–∞—É–∑–µ—Ä–∞..."
    open "http://localhost:$PORT"
    
    echo ""
    echo "================================"
    echo "‚ú® –ü—Ä–æ–µ–∫—Ç –∑–∞–ø—É—â–µ–Ω!"
    echo "üìç URL: http://localhost:$PORT"
    echo "================================"
    echo ""
    echo "–î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞–∂–º–∏—Ç–µ Ctrl+C –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "  pkill -f 'manuscript-editor/node_modules/.bin/vite'"
else
    echo "‚ùå –û—à–∏–±–∫–∞: —Å–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    exit 1
fi
